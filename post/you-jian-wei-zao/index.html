<!DOCTYPE html>
<html>
        <head>
        <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no" />
        <meta charset="utf-8">
        <title>邮件伪造 | 老白</title>
        <link rel="stylesheet" href="https://V-alkoinen.github.io/styles/main.css">
        <link rel="stylesheet" href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css">
        <link href="https://cdn.bootcss.com/animate.css/3.7.2/animate.min.css" rel="stylesheet">
         <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
        <script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>
         <script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
         <script >hljs.initHighlightingOnLoad();</script>

    </head>
    <body>
              <header class="header mdui-m-b-5">      
            <div class="container  ">
                <div class="index-title animated fadeInDown mdui-text-center mdui-text-color-white mdui-m-b-2" style="animation-delay: 0.2s"><a href="https://V-alkoinen.github.io">老白</a></div>
                <div class="mdui-text-color-white animated fadeInDown mdui-text-center  mdui-m-b-3" style="animation-delay: 0.4s"></div>
           
            <nav id="nav" class="mdui-text-center animated fadeInDown" style="animation-delay: 0.6s">
                   
                            <li><a href="/">首页</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                            <li><a href="/archives">归档</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                            <li><a href="/tags">标签</a>
                                <span class="nav-style top"></span>
                                <span class="nav-style bottom"></span>
                                <span class="nav-style left"></span>
                                <span class="nav-style right"></span>
                                </li>
                    
                  </nav>
                </div>
        </header>
        <div class="mdui-container ">
                <div class="mdui-row">
                        <div class="mdui-col-md-8 mdui-col-offset-md-2 ">
                                <article class="mdui-p-a-2 post animated fadeIn" style="animation-delay: 0.8s;animation-duration: 2s">
                                    <div class="post-title  mdui-m-b-1">邮件伪造</div>
                                    <div class="mdui-typo-body-2 mdui-m-b-2" datetime="2021-10-16 16:34:07">2021-10-16 / 7 min read</div>
                                    <div class="mdui-m-b-2 mdui-typo post-neirong"><h1 id="一-spf简介">一、SPF简介</h1>
<p>  <code>SPF</code> ，全称为 <code>Sender Policy Framework</code>，即发件人策略框架。<br>
  我们都知道，Email通信时，使用的是 SMTP 协议（<code>Simple Mail Transfer Protocol</code>），即简单邮件传输协议。此协议在通信过程中十分简陋，发件人的邮箱地址可以由发信方进行声明，所以协议本身没有很好的安全措施。SPF 出现的目的，就是为了解决 SMTP 的安全短板。</p>
<h1 id="二-spf原理">二、SPF原理</h1>
<p>  SPF记录实际上就是一条DNS记录，原理如下：<br>
  假设邮件服务器收到了一封邮件，发送方的IP为<code>IP_Sender</code>，并且发送方生成发件人为 <code>sender@example.com</code>。为了确认发件人是否是伪造的，邮件服务器会去查询<code>example.com</code>的 SPF 记录。如果该域的 SPF 记录设置允许 IP 为<code>IP_Sender</code>的主机发送邮件，则邮件服务器就会认为这封邮件是合法的；如果不允许，邮件服务器通常会退信，并将其标记为垃圾/仿冒邮件。<br>
  因为攻击者虽然可以声称他的邮件来自<code>example.com</code>，但是它却无法操作<code>example.com</code>的 DNS 记录，并且也无法伪造自己的 IP 地址。因此 SPF 被各大厂商认可，当下基本所有的邮件服务供应商（Gmail、腾讯邮箱等）都会去验证。</p>
<h1 id="三-漏洞利用">三、漏洞利用</h1>
<p> 使用 <a href="https://github.com/jetmore/swaks">Swaks</a>进行邮件伪造<br>
 <code>swaks --to &lt;target_address&gt; --from &lt;source_address&gt; --body &lt;email_body&gt; --header &lt;email_header&gt;</code><br>
<img src="https://V-alkoinen.github.io/post-images/1642930934304.png" alt="" loading="lazy"><br>
<img src="https://V-alkoinen.github.io/post-images/1642930975403.png" alt="" loading="lazy"></p>
<h1 id="四-spf记录的语法">四、SPF记录的语法</h1>
<p> 一条 SPF 记录定义了一个或者多个 mechanism，而 mechanism 则定义了哪些 IP 是允许的，哪些 IP 是拒绝的。<br>
 mechanism共包含以下几类：<br>
<code>all | ip4 | ip6 | include | a | mx | ptr | exists</code><br>
 每个mechanism可以选择以下四种前缀：</p>
<pre><code>&quot;+&quot;  Pass（通过）
&quot;-&quot;  Fail（拒绝）
&quot;~&quot;  Soft Fail（软拒绝）
&quot;?&quot;  Neutral（中立）
</code></pre>
<p> 服务器验证 SPF 记录时，会依次测试每个 mechanism ，如果命中IP，则验证结果由 mechanism 前缀决定，默认前缀为<code>+</code>，如果均没有命中，则结果为 Neutral。除此之外，还有三种情况，具体解释如下（下表中的处理方法仅是 SPF 标准做出的建议）：</p>
<table>
<thead>
<tr>
<th style="text-align:center">结果</th>
<th style="text-align:center">含义</th>
<th style="text-align:center">处理方法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Pass</td>
<td style="text-align:center">发件 IP 是合法的</td>
<td style="text-align:center">接受来信</td>
</tr>
<tr>
<td style="text-align:center">Fail</td>
<td style="text-align:center">发件 IP 是非法的</td>
<td style="text-align:center">退信</td>
</tr>
<tr>
<td style="text-align:center">Soft Fail</td>
<td style="text-align:center">发件 IP 非法，但是不采取强硬措施</td>
<td style="text-align:center">接受来信，但是做标记</td>
</tr>
<tr>
<td style="text-align:center">Neutral</td>
<td style="text-align:center">SPF 记录中没有关于发件 IP 是否合法的信息</td>
<td style="text-align:center">接受来信</td>
</tr>
<tr>
<td style="text-align:center">None</td>
<td style="text-align:center">服务器没有设定 SPF 记录</td>
<td style="text-align:center">接受来信</td>
</tr>
<tr>
<td style="text-align:center">PermError</td>
<td style="text-align:center">发生了严重错误（例如 SPF 记录语法错误）</td>
<td style="text-align:center">没有规定</td>
</tr>
<tr>
<td style="text-align:center">TempError</td>
<td style="text-align:center">发生了临时错误（例如 DNS 查询失败）</td>
<td style="text-align:center">接受或拒绝</td>
</tr>
</tbody>
</table>
<h1 id="五-关于mechanisms">五、关于Mechanisms</h1>
<p> <code>all</code>:表示所有 IP，肯定会命中。因此通常把它放在 SPF 记录的结尾，表示处理剩下的所有情况。</p>
<pre><code>&quot;v=spf1 -all&quot; 拒绝所有（表示这个域名不会发出邮件）
&quot;v=spf1 +all&quot; 接受所有（域名所有者认为 SPF 是没有用的，或者根本不在乎它）
</code></pre>
<p> <code>ip4</code>:格式为<code>ip4:&lt;ip4-address&gt;</code>或者<code>ip4:&lt;ip4-network&gt;/&lt;prefix-length&gt;</code>，指定一个 IPv4 地址或者地址段。如果<code>prefix-length</code>没有给出，则默认为/32。</p>
<pre><code>&quot;v=spf1 ip4:192.168.0.1/16 -all&quot;
只允许在 192.168.0.1 ~ 192.168.255.255 范围内的 IP
</code></pre>
<p> <code>ip6</code>:格式和<code>ip4</code>类似，默认的prefix-length是/128。</p>
<pre><code>&quot;v=spf1 ip6:1080::8:800:200C:417A/96 -all&quot;
只允许在 1080::8:800:0000:0000 ~ 1080::8:800:FFFF:FFFF 范围内的 IP
</code></pre>
<p> <code>a、mx</code>:两者格式相同</p>
<pre><code>a
a/&lt;prefix-length&gt;
a:&lt;domain&gt;
a:&lt;domain&gt;/&lt;prefix-length&gt;
</code></pre>
<p> 会命中相应域名的 a 记录（或 mx 记录）中包含的 IP 地址（或地址段）。如果没有提供域名，则使用当前域名。例如：</p>
<pre><code>&quot;v=spf1 mx -all&quot;
允许当前域名的 mx 记录对应的 IP 地址。

&quot;v=spf1 mx mx:deferrals.example.com -all&quot;
允许当前域名和 deferrals.example.com 的 mx 记录对应的 IP 地址。

&quot;v=spf1 a/24 -all&quot;
类似地，这个用法则允许一个地址段。

v=spf1 a mx ip4:173.194.72.103 -all
混合使用，支持当前域名的a记录和mx记录，同时也支持一个指定的IP地址
</code></pre>
<p> <code>include</code>:格式为<code>include:&lt;domain&gt;</code>，表示引入<code>&lt;domain&gt;</code>域名下的 SPF 记录。注意，如果该域名下不存在 SPF 记录，则会导致一个PermError结果。</p>
<pre><code>&quot;v=spf1 include:example.com -all&quot; 即采用和 example.com 完全一样的 SPF 记录
</code></pre>
<p> <code>exists</code>:格式为<code>exists:&lt;domain&gt;</code>。将对<code>&lt;domain&gt;</code>执行一个 A 查询，如果有返回结果（无论结果是什么），都会看作命中。<br>
 <code>ptr</code>:格式为<code>ptr</code>或者<code>ptr:&lt;domain&gt;</code>。使用ptr机制会带来大量很大开销的 DNS 查询，所以连官方都不推荐使用它。<br>
 <code>Modifiers</code>:SPF 记录中还可以包括两种可选的 modifier；一个 modifier 只能出现一次。</p>
<pre><code>#redirect
格式为redirect=&lt;domain&gt;,将用给定域名的 SPF 记录替换当前记录。

#exp
格式为exp=&lt;domain&gt;，目的是如果邮件被拒绝，可以给出一个消息。而消息的具体内容会首先对&lt;domain&gt;执行 TXT 查询，然后执行宏扩展得到。
</code></pre>
<pre><code>v=spf1:表示采用 SPF 1 版本，现在它的最新版本就是第 1 版。
</code></pre>
<h1 id="六-添加spf记录">六、添加SPF记录</h1>
<p> 如果想通过自己的域名发邮件，那么建议为它添加 SPF 记录，通常可以通过域名供应商提供的域名解析服务进行修改。不过有很多域名供应商并不支持 SPF 记录，我们也可以创建为一条 TXT 记录。至于合法的 IP ，如果你使用的第三方域名邮箱服务，会有固定的文档告诉我们如何填写。<br>
 SPF 记录本质上是一个 DNS 记录，所以并不是修改之后立即生效的——通常需要几个小时的时间。</p>
<h1 id="七-参考">七、参考</h1>
<p> <a href="http://www.openspf.org/">open SPF</a><br>
 <a href="http://www.openspf.org/Why">SPF Why</a><br>
 <a href="http://tools.bevhost.com/spf/">Beveridge SPF Test</a></p>
</div>
                                    <div class="mdui-divider mdui-m-b-2"></div>
                                    <div class="mdui-row-xs-2 post-fenye">
                                       
                                        <div class="mdui-col"> <div class="mdui-text-left"><a href="https://V-alkoinen.github.io/post/sickos-12/">SickOs 1.2</a></div></div>
                                        

                                        
                                        <div class="mdui-col"><div class="mdui-text-right "><a href="https://V-alkoinen.github.io/post/devsecops-liu-cheng/">DevSecOps 流程</a></div> </div>
                                       
                                      </div>
                                   
                                    <div class="mdui-divider mdui-m-t-2 mdui-m-b-2"></div>
                                    
                                     <script src="https://V-alkoinen.github.io/media/scripts/Valine.min.js"></script>
 <div class="comment"></div>

<script>
      new Valine({
            el: '.comment',



            path: window.location.pathname,
            pageSize: 30,
            avatar:'mm', 
       })
    </script> 
<script>
    if(window.location.hash){
        var checkExist = setInterval(function() {
           if ($(window.location.hash).length) {
              $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
              clearInterval(checkExist);
           }
        }, 100);
    }
</script>
                                </article>

                                    
                        </div>
                      </div>
    
                

              </div>
                    <footer class="footer mdui-m-t-5 mdui-text-center">
               <nav class="social-links">
                      <ul>
                      
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      
                           
                      </ul>
                    </nav>
                    <div class="copyright">
                      
                  </div>
                  
              </footer>
    </body>
</html>